<!DOCTYPE html>
<html>
<head>
    <title>Dynamic Form</title>
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet'>
    <link rel="stylesheet" href="assets/css/style-form.css">
</head>
<body>    <div id="seal-container">
        <img src="assets/img/seal.png" id="seal" style="display: none;" alt="Rotating PNG">
    </div>    <form id="dynamic-form" action="/submit-quote" method="post">
        <div class="form-header">
            <button type="button" id="openQuotesModal">Previous Quotes</button>
            <button type="button" id="openProfileModal" class="top-right-button">Saved Profiles</button>
        </div>
        <div class="input-group"></div>
        <h1>Quote Generator v5</h1>
        <h2>Client Information</h2>        
        <div class="input-group">
            <label for="client-name">Client Name</label><br>
            <input type="text" id="client-name" name="client-name" placeholder="John Smith" autofocus><br>
            
            <label for="address">Client Address</label><br>
            <input type="text" id="address" name="address" placeholder="1234 Streetname Ave, City"><br>
            
            <label for="phone">Client Phone number</label><br>
            <input type="tel" id="phone" name="phone" placeholder="123-456-7890"><br>
            
            <label for="reference">Quote Reference</label><br>
            <div style="display: flex; align-items: center;">
                <input type="text" id="reference" name="reference" placeholder="Client-reference" style="flex-grow: 1;">
                <button type="button" onclick="generateReference()" style="margin-left: 10px;">Generate Reference</button>
            </div>
            
            <label for="customer-name">Customer Name</label><br>
            <div style="display: flex; align-items: center;">
                <input type="text" id="customer-name" name="customer-name" placeholder="John Smith" style="flex-grow: 1;">
                <button type="button" onclick="generateCustomer()" style="margin-left: 10px;">Same as Client</button>
            </div>
        </div><br>
        
        <h2>Quote Comments</h2>
        <div id="comment-fields">
            <div class="input-group">
                <label for="comment">Comments:</label><br>
                <input type="text" id="comment" name="comment" placeholder="Quote Comments"><br>
            </div>
        </div>
        
        <button type="button" onclick="addComment()">Add Comment</button>
        <button type="button" class="negative-button" onclick="removeComment()">Remove Comment</button><br>
        
        <h2>Quote Costs</h2>
        <div id="cost-fields">
            <div class="input-group">
                <label for="cost-description">Costs:</label><br>
                <input type="text" id="cost-description" name="cost-description" placeholder="Item Description"><br><br>
                <input type="number" step="0.01" id="cost-amount" name="cost-amount" placeholder="123.45"><br><br>
            </div>
        </div>
        
        <button type="button" onclick="addCost()">Add Cost</button>
        <button type="button" class="negative-button" onclick="removeCost()">Remove Cost</button><br>

        <div id="form-buttons-container">
            <div id="form-buttons">
                <input type="submit" value="Submit">
                <button type="button" id="clear-button" class="negative-button">Clear</button>
            </div>
        </div>
    </form>

    <div id="quotesModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="scrollable-list">
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Saved Profiles</h2>
            <div class="scrollable-list" id="profileList">
            </div>
            <hr>
            <h3>Create New Profile</h3>
            <form id="profileForm">
                <div class="input-group">
                    <label for="profileName">Profile Name:</label>
                    <input type="text" id="profileName" name="profileName" required>
                </div>
                <div class="input-group">
                    <label for="company">Company Name:</label>
                    <input type="text" id="company" name="company" required>
                </div>
                <div class="input-group">
                    <label for="name">Your Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="input-group">
                    <label for="email">Email:</label>
                    <input type="text" id="email" name="email" required>
                </div>
                <div class="input-group">
                    <label for="profilePhone">Phone:</label>
                    <input type="text" id="profilePhone" name="phone" required>
                </div>
                <div class="input-group">
                    <label for="address1">Address Line 1:</label>
                    <input type="text" id="address1" name="address1" required>
                </div>
                <div class="input-group">
                    <label for="address2">Address Line 2:</label>
                    <input type="text" id="address2" name="address2">
                </div>
                <div class="input-group">
                    <label for="units">Currency Symbol:</label>
                    <input type="text" id="units" name="units" placeholder="$" required>
                </div>
                <div class="input-group">
                    <label for="document_type">Document Type:</label>
                    <input type="text" id="document_type" name="document_type" placeholder="Quotation" required>
                </div>
                <div class="input-group">
                    <label for="end_note">End Note:</label>
                    <input type="text" id="end_note" name="end_note" placeholder="For any concerns, reach out to...">
                </div>
                <div class="input-group">
                    <label for="foot_note">Footer Note:</label>
                    <input type="text" id="foot_note" name="foot_note" placeholder="Thank you for your business">
                </div>
                <div class="input-group">
                    <label for="tax_names">Tax Names (comma-separated):</label>
                    <input type="text" id="tax_names" name="tax_names" placeholder="GST, PST">
                </div>
                <div class="input-group">
                    <label for="tax_rates">Tax Rates (comma-separated %):</label>
                    <input type="text" id="tax_rates" name="tax_rates" placeholder="5, 7">
                </div>
                <button type="submit" style="width: 100%;">Save Profile</button>
            </form>
        </div>
    </div>

    <script>
        var quotesModal = document.getElementById("quotesModal");
        var openQuotesPage = document.getElementById("openQuotesModal");
        var profileModal = document.getElementById("profileModal");
        var openProfilePage = document.getElementById("openProfileModal");
        
        var span = document.getElementsByClassName("close");

        document.getElementById('clear-button').addEventListener('click', function(event) {
            if (confirm('Are you sure you want to clear the quote?')) {
                clearQuote()
            }
        });

        openQuotesPage.onclick = function() {
            openQuotesModal();
            quotesModal.style.display = "block";
        }

        openProfilePage.onclick = function() {
            openProfileModal();
            profileModal.style.display = "block";
        }

        // Close modal functionality for both modals
        for (let i = 0; i < span.length; i++) {
            span[i].onclick = function() {
                quotesModal.style.display = "none";
                profileModal.style.display = "none";
            }
        }

        window.onclick = function(event) {
            if (event.target == quotesModal) {
                quotesModal.style.display = "none";
            }
            if (event.target == profileModal) {
                profileModal.style.display = "none";
            }
        }

        function openQuotesModal() {
            fetch('/list-quotes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())            .then(files => {
                const listContainer = document.querySelector('#quotesModal .scrollable-list');
                listContainer.innerHTML = '<a href="#" id="triggerAnimation">ðŸ¦­</a>';
                files.forEach(file => {
                    const quoteDiv = document.createElement('div');
                    quoteDiv.className = 'quote-item';
                    quoteDiv.style.marginBottom = '10px';
                    quoteDiv.style.padding = '10px';
                    quoteDiv.style.border = '1px solid #ccc';
                    quoteDiv.style.borderRadius = '5px';
                    quoteDiv.style.position = 'relative';
                    
                    const quoteContent = document.createElement('div');
                    quoteContent.className = 'quote-content';
                    quoteContent.style.cursor = 'pointer';
                    quoteContent.style.paddingRight = '100px'; // Space for buttons
                    
                    const quoteTitle = document.createElement('h4');
                    quoteTitle.textContent = file.reference;
                    quoteTitle.style.margin = '0 0 5px 0';
                    
                    const quoteDetails = document.createElement('p');
                    quoteDetails.textContent = `${file.clientName || 'Unknown Client'} - ${file.date || 'No Date'}`;
                    quoteDetails.style.margin = '0';
                    quoteDetails.style.fontSize = '14px';
                    quoteDetails.style.color = '#666';
                    
                    quoteContent.appendChild(quoteTitle);
                    quoteContent.appendChild(quoteDetails);
                    
                    // Buttons container
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'quote-buttons';
                    buttonsContainer.style.position = 'absolute';
                    buttonsContainer.style.right = '10px';
                    buttonsContainer.style.top = '50%';
                    buttonsContainer.style.transform = 'translateY(-50%)';
                    buttonsContainer.style.display = 'flex';
                    buttonsContainer.style.gap = '5px';
                    
                    // Duplicate button
                    const duplicateBtn = document.createElement('button');
                    duplicateBtn.textContent = 'Duplicate';
                    duplicateBtn.className = 'btn-small btn-secondary';
                    duplicateBtn.style.fontSize = '12px';
                    duplicateBtn.style.padding = '4px 8px';
                    duplicateBtn.style.backgroundColor = '#6c757d';
                    duplicateBtn.style.color = 'white';
                    duplicateBtn.style.border = 'none';
                    duplicateBtn.style.borderRadius = '3px';
                    duplicateBtn.style.cursor = 'pointer';
                    duplicateBtn.onclick = (e) => {
                        e.stopPropagation();
                        duplicateQuote(file);
                    };
                    
                    // Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'btn-small btn-danger';
                    deleteBtn.style.fontSize = '12px';
                    deleteBtn.style.padding = '4px 8px';
                    deleteBtn.style.backgroundColor = '#dc3545';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.borderRadius = '3px';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteQuote(file.reference);
                    };
                    
                    buttonsContainer.appendChild(duplicateBtn);
                    buttonsContainer.appendChild(deleteBtn);
                    
                    quoteContent.addEventListener('click', () => {
                        loadQuoteForEditing(file);
                        quotesModal.style.display = "none";
                    });
                    
                    quoteDiv.appendChild(quoteContent);
                    quoteDiv.appendChild(buttonsContainer);
                    listContainer.appendChild(quoteDiv);
                })
                document.getElementById('quotesModal').style.display = 'block';                document.getElementById('triggerAnimation').addEventListener('click', function(e) {
                    e.preventDefault();
                    var container = document.getElementById('seal-container');
                    var img = document.getElementById('seal');
                    
                    container.classList.add('show');
                    img.style.display = 'block';
                    img.classList.add('show');

                    setTimeout(function() {
                        container.classList.remove('show');
                        img.style.display = 'none';
                        img.classList.remove('show');
                    }, 2000);
                });
            })
            .catch(error => console.error(error));
        }

        function openProfileModal() {
            fetch('/list-profiles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(profiles => {
                const listContainer = document.getElementById('profileList');
                listContainer.innerHTML = '';
                
                if (profiles.length === 0) {
                    const noProfiles = document.createElement('p');
                    noProfiles.textContent = 'No profiles saved yet.';
                    noProfiles.style.fontStyle = 'italic';
                    listContainer.appendChild(noProfiles);
                } else {                    profiles.forEach(profile => {
                        const profileDiv = document.createElement('div');
                        profileDiv.className = 'profile-item';
                        profileDiv.style.marginBottom = '10px';
                        profileDiv.style.padding = '10px';
                        profileDiv.style.border = '1px solid #ccc';
                        profileDiv.style.borderRadius = '5px';
                        profileDiv.style.position = 'relative';
                          const profileContent = document.createElement('div');
                        profileContent.className = 'profile-content';
                        profileContent.style.cursor = 'pointer';
                        profileContent.style.paddingRight = '150px'; // Space for buttons
                        
                        const profileTitle = document.createElement('h4');
                        profileTitle.textContent = profile.profileName;
                        profileTitle.style.margin = '0 0 5px 0';
                        
                        const profileDetails = document.createElement('p');
                        profileDetails.textContent = `${profile.company} - ${profile.name}`;
                        profileDetails.style.margin = '0';
                        profileDetails.style.fontSize = '14px';
                        profileDetails.style.color = '#666';
                        
                        profileContent.appendChild(profileTitle);
                        profileContent.appendChild(profileDetails);
                          // Buttons container
                        const buttonsContainer = document.createElement('div');
                        buttonsContainer.className = 'profile-buttons';
                        buttonsContainer.style.position = 'absolute';
                        buttonsContainer.style.right = '10px';
                        buttonsContainer.style.top = '50%';
                        buttonsContainer.style.transform = 'translateY(-50%)';
                        buttonsContainer.style.display = 'flex';
                        buttonsContainer.style.gap = '5px';
                        
                        // Edit button
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Edit';
                        editBtn.className = 'btn-small btn-primary';
                        editBtn.style.fontSize = '12px';
                        editBtn.style.padding = '4px 8px';
                        editBtn.style.backgroundColor = '#007bff';
                        editBtn.style.color = 'white';
                        editBtn.style.border = 'none';
                        editBtn.style.borderRadius = '3px';
                        editBtn.style.cursor = 'pointer';
                        editBtn.onclick = (e) => {
                            e.stopPropagation();
                            editProfile(profile);
                        };
                        
                        // Duplicate button
                        const duplicateBtn = document.createElement('button');
                        duplicateBtn.textContent = 'Duplicate';
                        duplicateBtn.className = 'btn-small btn-secondary';
                        duplicateBtn.style.fontSize = '12px';
                        duplicateBtn.style.padding = '4px 8px';
                        duplicateBtn.style.backgroundColor = '#6c757d';
                        duplicateBtn.style.color = 'white';
                        duplicateBtn.style.border = 'none';
                        duplicateBtn.style.borderRadius = '3px';
                        duplicateBtn.style.cursor = 'pointer';
                        duplicateBtn.onclick = (e) => {
                            e.stopPropagation();
                            duplicateProfile(profile);
                        };
                        
                        // Delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.className = 'btn-small btn-danger';
                        deleteBtn.style.fontSize = '12px';
                        deleteBtn.style.padding = '4px 8px';
                        deleteBtn.style.backgroundColor = '#dc3545';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.border = 'none';
                        deleteBtn.style.borderRadius = '3px';
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteProfile(profile.profileName);
                        };
                        
                        buttonsContainer.appendChild(editBtn);
                        buttonsContainer.appendChild(duplicateBtn);
                        buttonsContainer.appendChild(deleteBtn);
                        
                        profileContent.addEventListener('click', () => {
                            selectProfile(profile);
                            profileModal.style.display = "none";
                        });
                        
                        profileDiv.appendChild(profileContent);
                        profileDiv.appendChild(buttonsContainer);
                        listContainer.appendChild(profileDiv);
                    });
                }
            })
            .catch(error => console.error('Error loading profiles:', error));
        }        function selectProfile(profile) {
            // Store the selected profile data in sessionStorage
            const profileData = {
                company: profile.company,
                name: profile.name,
                phone: profile.phone,
                email: profile.email,
                address: profile.address || [profile.address1 || '', profile.address2 || ''].filter(addr => addr),
                units: profile.units || '$',
                tax_names: profile.tax_names || [],
                tax_rates: profile.tax_rates || [],
                end_note: profile.end_note || '',
                foot_note: profile.foot_note || '',
                document_type: profile.document_type || 'Quotation'
            };

            sessionStorage.setItem('selectedProfile', JSON.stringify(profileData));
            alert(`Profile "${profile.profileName}" selected successfully!`);
        }

        // Handle profile form submission
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const profileData = {};
            
            // Convert form data to object
            for (let [key, value] of formData.entries()) {
                profileData[key] = value;
            }
            
            // Handle address array
            profileData.address = [profileData.address1, profileData.address2].filter(addr => addr);
            delete profileData.address1;
            delete profileData.address2;
            
            // Handle tax arrays
            if (profileData.tax_names) {
                profileData.tax_names = profileData.tax_names.split(',').map(name => name.trim()).filter(name => name);
            } else {
                profileData.tax_names = [];
            }
            
            if (profileData.tax_rates) {
                profileData.tax_rates = profileData.tax_rates.split(',').map(rate => parseFloat(rate.trim())).filter(rate => !isNaN(rate));
            } else {
                profileData.tax_rates = [];
            }
              // Check if we're editing an existing profile
            const isEditing = this.dataset.editingProfile;
            const endpoint = isEditing ? '/update-profile' : '/submit-profile';
            
            if (isEditing) {
                profileData.originalProfileName = this.dataset.editingProfile;
            }
            
            // Submit profile
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(profileData)
            })
            .then(response => response.json())            .then(data => {                if (data.success) {
                    const action = isEditing ? 'updated' : 'saved';
                    alert(`Profile ${action} successfully!`);
                    this.reset();
                    delete this.dataset.editingProfile;
                      // Reset UI
                    document.querySelector('#profileForm button[type="submit"]').textContent = 'Save Profile';
                    document.querySelector('#profileModal h2').textContent = 'Saved Profiles';
                    document.querySelector('#profileModal .modal-content').classList.remove('editing');
                    
                    // Remove the edit button container and restore original button layout
                    const buttonContainer = document.getElementById('editButtonContainer');
                    if (buttonContainer) {
                        const submitButton = buttonContainer.querySelector('button[type="submit"]');
                        const form = document.getElementById('profileForm');
                        form.appendChild(submitButton);
                        buttonContainer.remove();
                    }
                    
                    const cancelButton = document.getElementById('cancelEditBtn');
                    if (cancelButton) {
                        cancelButton.style.display = 'none';
                    }
                    
                    // Show profile list and refresh it
                    document.getElementById('profileList').style.display = 'block';
                    openProfileModal(); // Refresh the profile list
                } else {
                    alert('Error saving profile');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving profile');
            });});

        // Duplicate profile function
        function duplicateProfile(profile) {
            const newProfileName = prompt(`Enter name for duplicated profile (original: "${profile.profileName}"):`);
            if (!newProfileName || newProfileName.trim() === '') {
                return;
            }

            const duplicatedProfile = {
                ...profile,
                profileName: newProfileName.trim()
            };

            fetch('/save-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(duplicatedProfile)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Profile duplicated as "${newProfileName}" successfully!`);
                    openProfileModal(); // Refresh the profile list
                } else {
                    alert('Error duplicating profile');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error duplicating profile');
            });
        }

        // Delete profile function
        function deleteProfile(profileName) {
            if (!confirm(`Are you sure you want to delete the profile "${profileName}"? This action cannot be undone.`)) {
                return;
            }

            fetch('/delete-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ profileName: profileName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Profile "${profileName}" deleted successfully!`);
                    openProfileModal(); // Refresh the profile list
                } else {
                    alert('Error deleting profile');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting profile');            });
        }        // Edit profile function
        function editProfile(profile) {
            // Hide the profile list and show the create form
            document.getElementById('profileList').style.display = 'none';
            document.querySelector('#profileModal h2').textContent = 'Edit Profile';
            document.querySelector('#profileModal .modal-content').classList.add('editing');
              // Populate the form with existing profile data
            document.getElementById('profileName').value = profile.profileName || '';
            document.getElementById('company').value = profile.company || '';
            document.getElementById('name').value = profile.name || '';
            document.getElementById('profilePhone').value = profile.phone || '';
            document.getElementById('email').value = profile.email || '';
            
            // Handle address array properly
            if (profile.address && Array.isArray(profile.address)) {
                document.getElementById('address1').value = profile.address[0] || '';
                document.getElementById('address2').value = profile.address[1] || '';
            } else {
                document.getElementById('address1').value = profile.address1 || '';
                document.getElementById('address2').value = profile.address2 || '';
            }
            
            document.getElementById('units').value = profile.units || '$';
            document.getElementById('tax_names').value = (profile.tax_names || []).join(', ');
            document.getElementById('tax_rates').value = (profile.tax_rates || []).join(', ');
            document.getElementById('end_note').value = profile.end_note || '';
            document.getElementById('foot_note').value = profile.foot_note || '';
            document.getElementById('document_type').value = profile.document_type || 'Quotation';
            
            // Store the original profile name for updating
            document.getElementById('profileForm').dataset.editingProfile = profile.profileName;
              // Change the form submit button text
            const submitButton = document.querySelector('#profileForm button[type="submit"]');
            submitButton.textContent = 'Update Profile';
            
            // Add a cancel button with proper container
            let cancelButton = document.getElementById('cancelEditBtn');
            if (!cancelButton) {
                cancelButton = document.createElement('button');
                cancelButton.type = 'button';
                cancelButton.id = 'cancelEditBtn';
                cancelButton.textContent = 'Cancel Edit';
                cancelButton.style.backgroundColor = '#6c757d';
                cancelButton.style.color = 'white';
                cancelButton.style.border = 'none';
                cancelButton.style.padding = '10px 20px';
                cancelButton.style.borderRadius = '5px';
                cancelButton.style.cursor = 'pointer';
                cancelButton.onclick = cancelEdit;
                
                // Create a button container for proper centering
                let buttonContainer = document.createElement('div');
                buttonContainer.id = 'editButtonContainer';
                buttonContainer.style.display = 'flex';
                buttonContainer.style.justifyContent = 'center';
                buttonContainer.style.gap = '10px';
                buttonContainer.style.marginTop = '20px';
                
                // Move submit button to container
                const submitButtonParent = submitButton.parentNode;
                submitButtonParent.removeChild(submitButton);
                buttonContainer.appendChild(submitButton);
                buttonContainer.appendChild(cancelButton);
                submitButtonParent.appendChild(buttonContainer);
            }
            cancelButton.style.display = 'inline-block';        }
        
        // Cancel edit function
        function cancelEdit() {
            // Reset the form
            document.getElementById('profileForm').reset();
            delete document.getElementById('profileForm').dataset.editingProfile;
            
            // Reset button text and modal title
            const submitButton = document.querySelector('#profileForm button[type="submit"]');
            submitButton.textContent = 'Save Profile';
            document.querySelector('#profileModal h2').textContent = 'Saved Profiles';
            document.querySelector('#profileModal .modal-content').classList.remove('editing');
            
            // Remove the edit button container and restore original button layout
            const buttonContainer = document.getElementById('editButtonContainer');
            if (buttonContainer) {
                const submitButton = buttonContainer.querySelector('button[type="submit"]');
                const form = document.getElementById('profileForm');
                form.appendChild(submitButton);
                buttonContainer.remove();
            }
            
            // Hide cancel button
            const cancelButton = document.getElementById('cancelEditBtn');
            if (cancelButton) {
                cancelButton.style.display = 'none';
            }
            
            // Show profile list
            document.getElementById('profileList').style.display = 'block';
        }

        // Load quote data into form for editing
        function loadQuoteForEditing(quoteData) {
            // Load basic information
            document.getElementById('client-name').value = quoteData['client-name'] || '';
            document.getElementById('address').value = quoteData['address'] || '';
            document.getElementById('phone').value = quoteData['phone'] || '';
            document.getElementById('reference').value = quoteData['reference'] || '';
            document.getElementById('customer-name').value = quoteData['customer-name'] || '';
            
            // Clear existing dynamic fields first
            clearQuote();
            
            // Load comments
            if (quoteData['comment'] && Array.isArray(quoteData['comment'])) {
                // Remove the default comment field first
                const commentFields = document.getElementById('comment-fields');
                commentFields.innerHTML = '';
                
                quoteData['comment'].forEach((comment, index) => {
                    if (comment.trim() !== '') {
                        addComment();
                        const commentInputs = document.querySelectorAll('input[name="comment"]');
                        if (commentInputs[index]) {
                            commentInputs[index].value = comment;
                        }
                    }
                });
                
                // If no comments, add one empty field
                if (quoteData['comment'].length === 0 || quoteData['comment'].every(c => c.trim() === '')) {
                    addComment();
                }
            } else {
                // Single comment or no comments
                addComment();
                const commentInput = document.querySelector('input[name="comment"]');
                if (commentInput && quoteData['comment']) {
                    commentInput.value = quoteData['comment'];
                }
            }
            
            // Load costs
            if (quoteData['cost-description'] && Array.isArray(quoteData['cost-description']) && 
                quoteData['cost-amount'] && Array.isArray(quoteData['cost-amount'])) {
                
                // Remove the default cost field first
                const costFields = document.getElementById('cost-fields');
                costFields.innerHTML = '';
                
                for (let i = 0; i < quoteData['cost-description'].length; i++) {
                    if (quoteData['cost-description'][i] && quoteData['cost-description'][i].trim() !== '') {
                        addCost();
                        const descriptionInputs = document.querySelectorAll('input[name="cost-description"]');
                        const amountInputs = document.querySelectorAll('input[name="cost-amount"]');
                        
                        if (descriptionInputs[i]) {
                            descriptionInputs[i].value = quoteData['cost-description'][i];
                        }
                        if (amountInputs[i]) {
                            amountInputs[i].value = quoteData['cost-amount'][i];
                        }
                    }
                }
                
                // If no costs, add one empty field
                if (quoteData['cost-description'].length === 0 || 
                    quoteData['cost-description'].every(desc => !desc || desc.trim() === '')) {
                    addCost();
                }
            } else {
                // Single cost or no costs
                addCost();
                const descInput = document.querySelector('input[name="cost-description"]');
                const amountInput = document.querySelector('input[name="cost-amount"]');
                if (descInput && quoteData['cost-description']) {
                    descInput.value = quoteData['cost-description'];
                }
                if (amountInput && quoteData['cost-amount']) {
                    amountInput.value = quoteData['cost-amount'];
                }
            }
            
            alert(`Quote "${quoteData['reference']}" loaded successfully!`);
        }

        // Dynamic form functions
        function addComment() {
            const commentFields = document.getElementById('comment-fields');
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            inputGroup.innerHTML = `
                <label for="comment">Comments:</label><br>
                <input type="text" name="comment" placeholder="Quote Comments"><br>
            `;
            commentFields.appendChild(inputGroup);
        }

        function removeComment() {
            const commentFields = document.getElementById('comment-fields');
            const inputGroups = commentFields.querySelectorAll('.input-group');
            if (inputGroups.length > 1) {
                commentFields.removeChild(inputGroups[inputGroups.length - 1]);
            }
        }

        function addCost() {
            const costFields = document.getElementById('cost-fields');
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            inputGroup.innerHTML = `
                <label for="cost-description">Costs:</label><br>
                <input type="text" name="cost-description" placeholder="Item Description"><br><br>
                <label for="cost-amount">Cost Amount:</label><br>
                <input type="number" step="0.01" name="cost-amount" placeholder="123.45"><br><br>
            `;
            costFields.appendChild(inputGroup);
        }

        function removeCost() {
            const costFields = document.getElementById('cost-fields');
            const inputGroups = costFields.querySelectorAll('.input-group');
            if (inputGroups.length > 1) {
                costFields.removeChild(inputGroups[inputGroups.length - 1]);
            }
        }

        function clearQuote() {
            // Clear all text inputs
            const textInputs = document.querySelectorAll('input[type="text"], input[type="tel"], input[type="number"]');
            textInputs.forEach(input => {
                input.value = '';
            });

            // Reset dynamic fields to single empty fields
            const commentFields = document.getElementById('comment-fields');
            commentFields.innerHTML = `
                <div class="input-group">
                    <label for="comment">Comments:</label><br>
                    <input type="text" id="comment" name="comment" placeholder="Quote Comments"><br>
                </div>
            `;

            const costFields = document.getElementById('cost-fields');
            costFields.innerHTML = `
                <div class="input-group">
                    <label for="cost-description">Costs:</label><br>
                    <input type="text" id="cost-description" name="cost-description" placeholder="Item Description"><br><br>
                    <label for="cost-amount">Cost Amount:</label><br>
                    <input type="number" step="0.01" id="cost-amount" name="cost-amount" placeholder="123.45"><br><br>
                </div>
            `;
        }

        function generateReference() {
            const clientName = document.getElementById('client-name').value;
            const address = document.getElementById('address').value;
            const date = new Date();
            
            const referenceArray = [];
            
            if (clientName) {
                referenceArray.push(clientName.split(' ')[0].toLowerCase());
            }
            
            if (address) {
                const streetMatch = address.match(/(?:\d+\s)?([a-zA-Z\s]+)(?:\s[a-zA-Z]+)?/);
                if (streetMatch && streetMatch[1]) {
                    referenceArray.push(streetMatch[1].trim().split(' ')[0].toLowerCase());
                }
            }
            
            if (!clientName && !address) {
                referenceArray.push(date.getDate().toString());
            }
            
            referenceArray.push((date.getMonth() + 1).toString());
            referenceArray.push(date.getFullYear().toString());
            
            document.getElementById('reference').value = referenceArray.join('-');
        }

        function generateCustomer() {
            const clientName = document.getElementById('client-name').value;
            document.getElementById('customer-name').value = clientName;
        }

        // Duplicate quote function
        function duplicateQuote(quote) {
            const newReference = prompt(`Enter reference for duplicated quote (original: "${quote.reference}"):`, quote.reference);
            if (!newReference || newReference.trim() === '') {
                return;
            }

            // Create a copy of the quote with new reference
            const duplicatedQuote = {
                ...quote,
                reference: newReference.trim(),
                date: new Date().toLocaleDateString()
            };

            fetch('/submit-quote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(duplicatedQuote)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Quote duplicated as "${newReference}" successfully!`);
                    openQuotesModal(); // Refresh the quotes list
                } else {
                    alert('Error duplicating quote');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error duplicating quote');
            });
        }

        // Delete quote function
        function deleteQuote(reference) {
            if (!confirm(`Are you sure you want to delete the quote "${reference}"? This action cannot be undone.`)) {
                return;
            }

            fetch('/delete-quote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reference: reference })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Quote "${reference}" deleted successfully!`);
                    openQuotesModal(); // Refresh the quotes list
                } else {
                    alert('Error deleting quote');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting quote');
            });
        }
    </script>
</body>
</html>
